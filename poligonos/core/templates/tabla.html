{% load static %}
<!DOCTYPE html>
<html>

<head>
    <title>Resultados de filtrado</title>
    <style>
        body {
            font-family: Arial, sans-serif;
        }

        h1 {
            margin: 0 auto;
            /* Centra horizontalmente */
            display: inline-block;
            /* Para ajustar el ancho del título al contenido */
            color: #333;
        }

        table {
            border-collapse: collapse;
            width: 100%;
            margin-top: 20px;
        }

        th,
        td {
            border: 1px solid #dddddd;
            text-align: left;
            padding: 8px;
        }

        th {
            background-color: #f2f2f2;
            font-weight: bold;
        }

        tr:nth-child(even) {
            background-color: #f9f9f9;
        }

        .text-uppercase {
            text-transform: uppercase;
        }

        .shape {
            font-style: italic;
        }

        .hidden-column {
            display: none;
        }

        #map {
            height: 600px;
            margin-top: 20px;
        }

        #resumen {
            display: inline-block;
            margin-top: 5px;
        }

        #resumen span {
            margin-right: 10px;
        }

        input {
            display: inline-block;
            border: none;
            padding: 8px 10px;
            margin-bottom: 20px;
            font-size: 16px;
            border-radius: 3px;
            box-shadow: inset 0 2px 2px rgba(0, 0, 0, 0.1);
        }

        input:focus {
            outline: none;
        }

        /* Estilos para los botones "Descargar KML" y "Descargar GEOJSON" */
        .btn-container {
            display: flex;
            justify-content: flex-end;
            align-items: center;
            margin-bottom: 20px;
        }

        .btn-container button {
            background-color: #61b0a3;
            color: #fff;
            cursor: pointer;
            padding: 10px 45px;
            margin-left: 10px;
            border-radius: 4px;
            border: none;
            box-shadow: inset 0 2px 2px rgba(0, 0, 0, 0.1);
        }

        .btn-container button:hover {
            background-color: #4a98c7;
        }
    </style>

    <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.10.25/css/jquery.dataTables.min.css">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.datatables.net/1.10.25/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/ol/dist/ol.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-9ndCyUaIbzAi2FUVXJi0CjmCapSmO7SnpJef0486qhLnuZ2cdeRhO02iuK6FUUVM" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-geWF76RCwLtnZ8qwWowPQNguL3RmwHVBC9FhGdlKrxdiJJigb/j/68SIy3Te4Bkz"
        crossorigin="anonymous"></script>
</head>

<body>
    <div class="container">
        <div class="btn-container">
            <h1 style="padding-left: 333px;">Resultados de filtrado</h1>
            <button id="btnKML">Descargar KML</button>
            <button id="btnJson">Descargar GEOJSON</button>
            <div id="loader" class="loader"></div>
        </div>
    </div>

    <div id="map"></div>
    <div class="container d-flex justify-content-center gap-5">
        <button class="btn btn-success m-3" id="buttonList">Poligonos seleccionados</button>
        <button class="btn btn-success m-3" id="buttonAll">Todos los poligonos</button>
    </div>
    <table id="myTable">
        <thead>
            <tr>
                <th></th>
                <th>Provincia</th>

                <th>Localidad</th>
                <th>Score Promedio %</th>
                <th>Q Geo</th>
                <th>Índice Geo</th>
                <th>Q Estimada</th>
                <th>Q Personas Priorizadas</th>
                <th>Hogares Estimados</th>
                <th>Observado</th>
                <th class="hidden-column">Shape Texto</th>
            </tr>
        </thead>
        <tbody>
            {% for dato in datos %}
            <tr>
                <td><input type="checkbox" class="row-checkbox"></td>
                <td class="text-uppercase mx-auto">{{ dato.distrito_nombre }}</td>
                <td class="text-uppercase">{{ dato.seccion_nombre }}</td>

                <td>{{ dato.score_promedio }}%</td>
                <td>{{ dato.cant_personas }}</td>
                <td>{{ dato.indice_geo }}</td>
                <td>{{ dato.cant_personas }}</td>
                <td>{{ dato.cant_personas_prio }}</td>
                <td>{{ dato.cant_hogares }}</td>
                <td>{{ dato.observado }}</td>
                <td class="shape hidden-column">{{ dato.shape_texto }}</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    <h4 style="margin-bottom:3px;margin-top: 1px;">Datos seleccionados:</h4>
    <div id="resumen" style="display: inline-block;"></div>



    <script>

        let polygonList = []
        localStorage.setItem('polygonList', JSON.stringify(polygonList));
        function actualizarResumen() {
            polygonList = []
            var seleccionados = $('#myTable tbody input.row-checkbox:checked');
            var resumenHtml = '';
            // console.log(seleccionados);
            if (seleccionados.length > 0) {
                var totalScores = 0;
                var cantidadSeleccionados = seleccionados.length;

                seleccionados.each(function () {
                    var row = $(this).closest('tr');

                    // console.log(row.find('td:eq(10)').text());
                    polygonList.push(row.find('td:eq(10)').text());
                    var scorePromedio = parseFloat(row.find('td:eq(3)').text());
                    totalScores += scorePromedio; // suma los datos
                    localStorage.setItem('polygonList', JSON.stringify(polygonList));
                });

                var porcentaje = (totalScores / cantidadSeleccionados).toFixed(2); // saca el porcentaje 
                resumenHtml = '<span>Total de poligonos seleccionados: ' + cantidadSeleccionados + '</span>';
                resumenHtml += '<span> | Porcentaje de score promedio: ' + porcentaje + '%</span>';
            } else {
                resumenHtml = '<span>No hay elementos seleccionados.</span>';
            }

            $('#resumen').html(resumenHtml);
        }

        $(document).ready(function () {
            var table = $('#myTable').DataTable({
                ordering: true, // Sirve para ordenar las columnas 
                language: {
                    url: "{% static 'js/Espanol.json' %}" // Especifica la ruta al archivo de idioma en español
                }
            });

            $('#myTable thead th input[type="checkbox"]').on('click', function () {
                if (this.checked) {
                    $('#myTable tbody input.row-checkbox').prop('checked', true);
                } else {
                    $('#myTable tbody input.row-checkbox').prop('checked', false);
                }

                actualizarResumen();
            });

            $('#myTable tbody').on('click', 'input.row-checkbox', function () {
                actualizarResumen();
            });
        });



    </script>

    <script src="{% static 'js/main.js' %}"></script>
    <script src="{% static 'js/Espanol.json' %}"></script>
</body>

</html>